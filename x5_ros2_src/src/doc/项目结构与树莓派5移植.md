# 项目代码结构与功能模块说明（ROS 2 Humble）

## 工作空间结构概览

- 顶层目录：`src/`（源码）、`depend/`（第三方依赖）、`build/` `install/` `log/`（`colcon` 构建输出）
- 典型 ROS 2 叠加层布局，所有包位于 `src/` 下；构建使用 `ament`/`colcon`，包清单由各自 `package.xml` 与 `CMakeLists.txt`/`setup.py` 定义

## 包与模块总览

- 底盘与控制：`turn_on_wheeltec_robot`、`wheeltec_joy`、`wheeltec_robot_keyboard`、`wheeltec_robot_msg`
- 传感器与外设：`usb_cam-ros2`（UVC 摄像头）、`wheeltec_lidar_ros2`（`rplidar_ros`、`ldlidar*`、`LSlidar`）、`wheeltec_gps`（`nmea_navsat_driver`、`ublox-ros2`、双 RTK）、`ros2_astra_camera-master`、`wheeltec_bodyreader`
- 导航与路径：`navigation2-humble`（Nav2 全套）、`wheeltec_robot_nav2`、`nav2_waypoint_cycle`、`wheeltec_path_follow`
- SLAM 与视觉：`wheeltec_robot_slam`（`slam_gmapping`、`cartographer`、`slam_toolbox`）、`orb_slam_2_ros-ros2`、`aruco_ros-humble-devel`
- 语音与交互：`wheeltec_aiui`、`tts_make_ros2`、`wheeltec_mic`、`ollama_ros_chat`
- 可视化与工具：`wheeltec_rviz2`、`wheeltec_robot_urdf`、`web_video_server-ros2`
- 其他：`auto_recharge_ros2`（自动回充）、`simple_follower_ros2`（AR 追随）、`wheeltec_rrt_msg`、`wheeltec_multi`、`wheeltec_robot_kcf`、`wheeltec_robot_rtab`

## 核心底盘控制

- `turn_on_wheeltec_robot`
  - 作用：与下位机（STM32）串口通信，桥接速度指令与里程计/IMU/电压等传感数据；发布 `odom`、`imu/data_raw`、`PowerVoltage` 等话题
  - 输入：`geometry_msgs/Twist` 的 `cmd_vel`；自动回充相关订阅 `robot_recharge_flag`、`red_vel`
  - 输出：`nav_msgs/Odometry`、`sensor_msgs/Imu`、`std_msgs/Float32`（电压）、自动回充状态话题
  - 关键实现：
    - 主循环与话题发布：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:620`
    - 速度指令打包并串口发送：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:55`
    - 里程计发布：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:129`
    - IMU 发布：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:100`
    - 串口打开与参数声明：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:683`

- `wheeltec_robot_msg`
  - 自定义消息：`msg/Data.msg`（`x,y,z`）、`msg/Supersonic.msg`（超声八方向距离）

- `wheeltec_joy`
  - 作用：订阅 `sensor_msgs/Joy` 并发布 `cmd_vel`；支持麦克纳姆平移模式切换
  - 回调与发布：`src/wheeltec_joy/src/wheeltec_joy_control.cpp:41`

## 传感器与外设

- 相机：`usb_cam-ros2`（V4L2 UVC 摄像头驱动，发布图像）、`ros2_astra_camera-master`（Astra 深度相机）
- 激光雷达：`wheeltec_lidar_ros2` 包含多型雷达驱动（`rplidar_ros`、`ldlidar_stl06n_ros2/ldlidar14`、`LSlidar`）
- GNSS：`wheeltec_gps`
  - NMEA 驱动：`nmea_navsat_driver`（串口/Socket/TCP 客户端）
  - u-blox 驱动：`ublox-ros2`（多固件版本支持）
  - 双 RTK：`wheeltec_dual_rtk_driver`（`um982_serial.py` 等）
  - 集成与可视化：`wheeltec_gps_driver`（路径展示与 Launch）
- 人体骨骼：`wheeltec_bodyreader`（依赖 Astra SDK 的 `libastra.so`，发布 `Body.msg`）

## 导航与路径

- Nav2 全套：`navigation2-humble` 子包（`nav2_controller`、`nav2_planner`、`nav2_costmap_2d`、`nav2_util` 等）
- 集成与参数：`wheeltec_robot_nav2`
  - 各底盘参数：`src/wheeltec_robot_nav2/param/wheeltec_params/*.yaml`
  - 启动：`bringup_launch.py`、`wheeltec_nav2.launch.py`
- 路径跟随：`wheeltec_path_follow`
  - 读取路径文件并调用 Nav2 执行：`src/wheeltec_path_follow/scripts/follow_path.py:45`
- 航点循环：`nav2_waypoint_cycle`

## SLAM 与视觉

- 经典 SLAM：`wheeltec_robot_slam`
  - `slam_gmapping`（激光雷达 2D SLAM）：`src/wheeltec_robot_slam/slam_gmapping/src/slam_gmapping.cpp`
  - `wheeltec_cartographer`（Cartographer）和 `wheeltec_slam_toolbox`（开源 2D/3D SLAM）
- 视觉 SLAM：`orb_slam_2_ros-ros2`（单目/双目/RGB-D 多节点）
- 标记追踪：`aruco_ros-humble-devel`（Aruco 检测与消息）

## 语音与交互

- 讯飞 AIUI：`wheeltec_aiui`（`libs/arm64/libaiui.so` 等，发布/订阅语音交互话题，Launch 在 `launch/aiui_start.launch.py`）
- 讯飞 TTS：`tts_make_ros2`（`libs/arm64/libmsc.so`，`src/tts_make.cpp`，话题与参数在 `config/`）
- 麦克风：`wheeltec_mic`（语音采集与消息）
- LLM 聊天：`ollama_ros_chat`（服务 `ollama_ros_msgs/srv/Chat.srv`，需系统安装 `ollama`）

## 可视化与描述

- 机器人 URDF：`wheeltec_robot_urdf`（模型与 TF）
- RViz 配置：`wheeltec_rviz2`（场景与显示项）
- Web 视频：`web_video_server-ros2`（浏览器查看图像流）

## 自动回充

- `auto_recharge_ros2`
  - 作用：基于 Nav2 的自动寻桩与红外对接，协调速度与服务 `/set_charge`
  - 关键实现：`src/auto_recharge_ros2/auto_recharge_ros2/auto_recharger.py:95`
  - 文件依赖：`Charger_Position.json`、`robot_info.yaml`

## 构建与运行

- 依赖安装：`ros-humble-*` 全套、`colcon`、`v4l2`、`opencv`、`eigen`、`pcl`、`ceres`（根据所用模块选装）
- 构建命令：
  - `source /opt/ros/humble/setup.bash`
  - `colcon build --symlink-install`
  - `source install/setup.bash`
- 设备映射：串口名默认 `"/dev/wheeltec_controller"`，通过 `wheeltec_udev.sh` 设置 udev 规则；在参数 `usart_port_name` 可更改（`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:700`）

---

# 移植至树莓派 5 可行性分析

## 结论摘要

- 可行性：整体可行。Pi 5（ARM64，8GB/16GB）性能足以运行 Nav2 与 2D SLAM；语音与相机/雷达模块多数提供源码或 ARM64 动态库
- 注意项：个别依赖是专有二进制（如 Astra SDK），需确认是否有 ARM64 版本；`ollama` 在 ARM64 上支持但资源占用较高

## 建议系统与 ROS 版本

- 操作系统：Ubuntu 22.04 LTS 64-bit for Raspberry Pi（官方 Jammy 映像）
- ROS 2：Humble Hawksbill（与当前工作区一致）；亦可考虑 Iron/Jazzy，但需检查 `navigation2-humble` 兼容性

## 模块兼容性速览

- 底盘驱动（`turn_on_wheeltec_robot`）：使用 `serial` 库与 POSIX 串口，ARM64 无差异；注意 udev 与串口权限
- 雷达与相机：`rplidar_ros`、`ldlidar`、`usb_cam` 均为跨平台源码；Astra 需 ARM64 `libastra.so`
- GNSS：`nmea_navsat_driver`、`ublox-ros2` 支持 ARM64；双 RTK 串口脚本适配即可
- 导航/SLAM：Nav2、`slam_toolbox`、Cartographer 在 Pi 5 可用，但编译与运行需优化（开启 `-j` 合理值，交换分区、降低分辨率/频率）
- 语音：`tts_make_ros2` 与 `wheeltec_aiui` 已内置 `libs/arm64` 动态库，适配 ARM64
- 视觉 SLAM：`orb_slam2` 可在 ARM64 编译（需 `Eigen3`、`OpenCV`、`Pangolin`），运行性能受限于相机分辨率与特征数量
- LLM 聊天：`ollama_ros_chat` 依赖系统 `ollama`，Pi 5 上可安装（ARM64），但模型体积与 RAM 要求高

## 可能的移植风险

- Astra SDK：`wheeltec_bodyreader/bodyreader/lib/libastra.so` 需确认架构；若为 x86-64，则必须替换为 ARM64 版本或在 Pi 上禁用该包
- 专有驱动二进制：部分第三方雷达/相机若使用预编译 `.so`，需 ARM64 版本；否则从源码编译
- 路径硬编码：如 `auto_recharger.py` 中 `json_file`/`yaml_file` 使用绝对路径（`/home/wheeltec/...`），需改参数或相对路径以适配 Pi 5 文件结构（`src/auto_recharge_ros2/auto_recharge_ros2/auto_recharger.py:49`）

## 推荐移植步骤

1. 刷写系统：安装 Ubuntu 22.04 64-bit（Raspberry Pi 官方），启用 64-bit 内核与性能模式
2. 安装 ROS 2 Humble：`ros-humble-desktop`、`colcon`、`python3-colcon-common-extensions`
3. 安装依赖：`libopencv-dev`、`libeigen3-dev`、`libpcl-dev`、`ceres-solver`、`v4l-utils` 等（按需）
4. 克隆工作区：将当前 `src/` 放入 Pi 5 的 ROS 2 工作区，执行 `colcon build`
5. 串口与 udev：运行/调整 `turn_on_wheeltec_robot/wheeltec_udev.sh`，确保设备名 `"/dev/wheeltec_controller"` 正确，或在 `usart_port_name` 参数中指定实际串口
6. 校验底盘：仅启用 `turn_on_wheeltec_robot` + `wheeltec_joy`，验证 `cmd_vel`→串口下发与 `odom`/`imu` 发布
7. 逐步启用传感器：相机、雷达、GNSS 分别编译和测试；对 Astra/BodyReader 若无 ARM64 SDK，先跳过
8. 导航与 SLAM：按底盘型号选择 `wheeltec_robot_nav2` 的参数 YAML，启动 Nav2；随后选择 `slam_toolbox` 或 Cartographer 进行建图与导航
9. 语音与交互：验证 `tts_make_ros2` 与 `wheeltec_aiui` 的 ARM64 `.so` 正常加载；`ollama_ros_chat` 按需部署
10. 性能优化：降低图像分辨率、雷达频率；设置 `GPU_MEM` 与交换分区大小；调参 Nav2 控制器与代价地图刷新率

## 额外建议

- 统一路径与参数：将硬编码路径改为参数读取或相对路径，减少平台耦合
- 包选择：根据项目需求裁剪高负载模块（ORB-SLAM2、Astra BodyReader、LLM 聊天）以保证实时性
- 安全与权限：串口与设备权限设置，避免以 `root` 运行；不在日志中输出敏感信息

---

## 参考代码位置索引（便于 IDE 跳转）

- `turn_on_wheeltec_robot`
  - 主循环与话题发布：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:620`
  - 速度指令回调：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:55`
  - 里程计发布：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:129`
  - IMU 发布：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:100`
  - 参数声明与串口初始化：`src/turn_on_wheeltec_robot/src/wheeltec_robot.cpp:683`
- `wheeltec_joy` 回调：`src/wheeltec_joy/src/wheeltec_joy_control.cpp:41`
- 自动回充节点：`src/auto_recharge_ros2/auto_recharge_ros2/auto_recharger.py:95`
- 路径跟随：`src/wheeltec_path_follow/scripts/follow_path.py:45`

---

# 车载深度+激光+末端单目抓取MVP方案

## 架构与数据流

- 车载激光建图与导航：激光作为定位与路径规划主源，`slam_toolbox`/`cartographer`→Nav2
- 深度点云增强障碍：Astra Pro 发布 `/camera/depth/points`，加入 Nav2 `voxel_layer` 与 `obstacle_layer`
- 末端单目识别定位：`aruco_ros` 检测标记并发布 `/aruco_single/pose`，抓取节点生成抓取位姿

## 实施要点

- 手眼标定：标定 `ee_link → camera_link`，加入 TF
- 代价地图融合：在 `param_mini_mec.yaml` 为本地/全局代价地图增加 `PointCloud2` 源 `depth_points`
- 抓取规划：订阅标记位姿，按固定偏移与姿态生成抓取位姿并发布

## 联合启动

- 新增 `wheeltec_robot_nav2/launch/mvp_bringup.launch.py` 启动底盘、雷达、Nav2、Astra 相机与抓取管线
- 默认深度点云话题：`/camera/depth/points`；标记位姿话题：`/aruco_single/pose`

---

# 项目结构更新摘要（新增包与关键改动）

- 新增包：`wheeltec_grasp_mvp`
  - 作用：订阅 ArUco 位姿并生成抓取位姿（偏移与姿态规则），发布 `PoseStamped` 至 `/grasp_pose`
  - 入口：`wheeltec_grasp_mvp/grasp_planner.py:1`
  - 启动：`wheeltec_grasp_mvp/launch/mvp_grasp.launch.py`

- 新增联合启动：`wheeltec_robot_nav2/launch/mvp_bringup.launch.py`
  - 集成底盘、雷达、Nav2、Astra Pro 相机、Aruco 检测与抓取规划
  - 可通过 `usart_port_name`、`serial_baud_rate`、`marker_id`、`marker_size`、`ee_image`、`ee_camera_info` 参数覆盖

- 代价地图融合深度点云（Nav2 参数）
  - 文件：`wheeltec_robot_nav2/param/wheeltec_params/param_mini_mec.yaml`
  - 本地体素层与全局障碍层的 `observation_sources` 增加 `depth_points`（`PointCloud2`），话题默认 `/camera/depth/points`

- 路径与串口参数化改动
  - 自动回充文件路径改为包路径参数：`auto_recharge_ros2/auto_recharge_ros2/auto_recharger.py:49`、`95`、`149`
  - 路径跟随默认路径改为包路径参数：`wheeltec_path_follow/scripts/follow_path.py:49`
  - 底盘串口 Launch 支持外部透传：`turn_on_wheeltec_robot/launch/base_serial.launch.py:13`、`15`、`18`
  - 导航顶层 Launch 透传底盘串口参数：`wheeltec_robot_nav2/launch/wheeltec_nav2.launch.py:10`、`36`、`53`

- 自启动脚本与服务（可选部署）
  - 脚本：`autostart/launch_rdkx5.sh`（支持 `USART_PORT_NAME`、`SERIAL_BAUD_RATE` 环境变量注入）
  - 服务模板：`autostart/ros2-rdkx5.service`（设置用户、工作目录与脚本路径）

- 相机点云发布（Astra Pro）
  - 点云话题：`ros2_astra_camera-master/astra_camera/src/point_cloud_proc/point_cloud_xyz.cpp:63` → `depth/points`
  - 启动文件：`ros2_astra_camera-master/astra_camera/launch/astra_pro.launch.xml`