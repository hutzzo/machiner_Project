# 串口通信与控制协议

 


## 通信通道
- 默认端口：`USART3`，`115200 8N1`，作为与上位机（ROS/PC）通信的通道（BALANCE/system.c:232-241）
- 备用端口：`USART5`，`115200 8N1`（BALANCE/system.c:237-241）
- 其他端口：`USART1` 可收发同格式数据（HARDWARE/usartx.c:241-283）

## 发送数据（STM32 → 上位机）
- 任务频率：20Hz（HARDWARE/usartx.c:20-23）
- 统一打包后分别通过 `USART1/3/5` 发送（HARDWARE/usartx.c:14-34）
- 帧格式（24 字节）：
  - 帧头：`0x7B`（HARDWARE/usartx.h:11）
  - 标志位：`buffer[1]=Flag_Stop`（软件故障禁能标志）（HARDWARE/usartx.c:93-95）
  - 三轴速度（mm/s，int16，大端）：`X→[2,3]`、`Y→[4,5]`、`Z→[6,7]`（HARDWARE/usartx.c:98-103）
  - 加速度（IMU int16）：`X→[8,9]`、`Y→[10,11]`、`Z→[12,13]`（HARDWARE/usartx.c:106-113）
  - 角速度（IMU int16）：`X→[14,15]`、`Y→[16,17]`、`Z→[18,19]`（HARDWARE/usartx.c:116-121）
  - 电压（×1000）：`[20,21]`（HARDWARE/usartx.c:125-126）
  - 校验：`buffer[22]=XOR(buffer[0..21])`（HARDWARE/usartx.c:128-133,1028-1048）
  - 帧尾：`0x7D`（HARDWARE/usartx.h:12）
- 发送函数：`USART3_SEND`（HARDWARE/usartx.c:159-166），`USART1_SEND`（HARDWARE/usartx.c:142-150），`USART5_SEND`（HARDWARE/usartx.c:195-202）

## 接收控制（上位机 → STM32）
- 车辆三轴速度控制帧（CAR）
  - 端口处理：`USART3_IRQHandler`（HARDWARE/usartx.c:701-802）、`USART1_IRQHandler`（HARDWARE/usartx.c:454-560）、`UART5_IRQHandler`（HARDWARE/usartx.c:812-901）
  - 帧格式（11 字节）：`0x7B [保留] [Xh][Xl] [Yh][Yl] [Zh][Zl] [chk] 0x7D`
    - 单位：mm/s；有符号 16 位大端；解析后转 m/s（HARDWARE/usartx.c:748-751,955-966）
    - 校验：前 9 字节 XOR 在 `[9]`（HARDWARE/usartx.c:734-751）
    - 模式切换：收到有效帧置为串口控制模式（清除其它源标志）（HARDWARE/usartx.c:736-745）
- 机械臂角度控制帧（MOVEIT）
  - 端口处理：同上（HARDWARE/usartx.c:701-802,454-560,812-901）
  - 帧格式（16 字节）：`0xAA [J1h][J1l] … [J6h][J6l] [mode] [chk] 0xBB`
    - 角度：弧度×1000（int16 大端），解析后乘 `0.001f` 得弧度（HARDWARE/usartx.c:769-782,538-551）
    - 模式：`mode=2`（follower）使用低增益 PID；默认较高增益（HARDWARE/usartx.c:784-786,553-555）
    - 校验：XOR `[0..13]` → `[14]`；尾 `[15]=0xBB`（HARDWARE/usartx.c:761-766,758-759）

## 数据来源与单位
- 三轴速度由编码器换算 m/s（BALANCE/balance.c:934-940），再按车型运动学计算三轴（HARDWARE/usartx.c:51-70）
- 发送时速度乘 1000 写入整型（HARDWARE/usartx.c:54-56,60-63,66-69,98-103）
- IMU 数据为原始 int16；电压为实测值×1000（HARDWARE/usartx.c:90-92,125-126）

## 上位机对接说明
- 打开串口设备，设置 `115200 8N1`
- 发送 CAR 控制时：按 11 字节格式写入 mm/s，计算 XOR 校验到 `[9]`
- 发送 MOVEIT 控制时：按 16 字节格式写入弧度×1000，`mode` 按需设置，计算 XOR 到 `[14]`
- 接收状态帧时：验证头尾与 XOR，速度除以 1000 得 m/s；电压除以 1000 得伏特

## 示例（十六进制）
- CAR 帧（X=+200mm/s，Y=0，Z=0）：`7B 00 00 C8 00 00 00 00 CS 7D`
- MOVEIT 帧（J1=+0.5rad，其余 0，mode=1）：`AA 01 F4 00 00 00 00 00 00 00 00 00 00 01 CS BB`