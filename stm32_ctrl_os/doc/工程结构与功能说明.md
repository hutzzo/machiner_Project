# R550A_C30D(2.0) 工程结构与功能说明

## 项目概览
- 目标平台：`STM32F407`，使用 `FreeRTOS` 进行任务调度
- 功能范围：多车型底盘（麦克纳姆、四驱、履带）运动学与速度闭环、六自由度机械臂舵机控制、OLED 显示、蜂鸣器与自检、APP/PS2/模型遥控/CAN/串口多源控制
- 主循环频率：控制任务 100Hz（10ms），显示任务 10Hz

## 目录结构
- `USER/`：应用入口与 Keil 工程文件
  - 主函数创建任务并启动调度：`USER/main.c:34-46`
  - 启动任务创建各业务任务与 IMU 型号选择：`USER/main.c:53-63`
- `BALANCE/`：业务逻辑层
  - 控制主循环与运动学/PI 控制：`BALANCE/balance.c`
  - 传感器任务（MPU6050/ICM20948）：`BALANCE/imu_task.c`
  - 车型选择与参数初始化：`BALANCE/robot_select_init.c`
  - 系统变量与硬件初始化：`BALANCE/system.c`
  - OLED 显示与提示：`BALANCE/show.c`
- `HARDWARE/`：驱动层
  - 编码器接口 TIM2/3/4/5：`HARDWARE/encoder.c`
  - 电机 PWM TIM1/9/10/11、使能引脚：`HARDWARE/motor.c`
  - 舵机 PWM TIM8/TIM12 与模型遥控输入捕获：`HARDWARE/timer.c`
  - 串口/CAN/OLED/I2C/Flash 等：`usartx.*`、`can.*`、`oled.*`、`I2C.*`、`stmflash.*`
- `SYSTEM/`：基础系统封装（延时、系统、串口）：`SYSTEM/delay/*`、`SYSTEM/sys/*`、`SYSTEM/usart/*`
- `FreeRTOS/`：RTOS 内核与配置；`FWLIB/`：ST 外设库；`CORE/`：CMSIS 与启动文件
- `OBJ/`：编译产物（`WHEELTEC.hex`）；根目录固件镜像 `*.hex`

## 关键任务与流程
- 启动任务 `start_task`：创建控制、IMU、显示、LED、PS2、数据发送等任务：`USER/main.c:53-63`
- 控制主循环 `Balance_task`（100Hz）：
  - 读取编码器并换算成车轮速度（m/s）：`BALANCE/balance.c:913-940`
  - 解析控制输入源→生成三轴目标速度：`BALANCE/balance.c:130-138`
  - 逆运动学分解到各轮目标速度：`BALANCE/balance.c:42-71,76-87`
  - 增量式 PI 速度闭环得到 PWM：`BALANCE/balance.c:518-557`
  - PWM 限幅与极性设置，输出到电机与舵机：`BALANCE/balance.c:156-167,368-414`
- IMU 任务（100Hz）：读取加速度与角速度，启动阶段刷新零偏：`BALANCE/imu_task.c:6-28,31-67`
- 显示任务（10Hz）：电压采样、蜂鸣器提示、APP 数据发送、OLED 刷新：`BALANCE/show.c:18-71,81-200`

## 输入源与优先级
- 蓝牙 APP：`Get_RC` 将方向/速度/转向映射为 `Move_X/Y/Z` 并单位换算：`BALANCE/balance.c:632-689`
- PS2 控制器：摇杆阈值抑制与速度/角速度映射：`BALANCE/balance.c:699-772`
- 模型遥控器（PWM 捕获 TIM8）：通道脉宽解析为四通道值：`HARDWARE/timer.c:162-310`，控制解析：`BALANCE/balance.c:782-852`
- CAN/串口直控三轴速度，无需额外处理：`BALANCE/balance.c:134-138`
- 输入源选择优先级：APP → 模型遥控 → PS2 → CAN/串口

## 运动学与控制闭环
- 麦克纳姆四轮：四轮目标速度组合含 `Axle_spacing` 与 `Wheel_spacing`：`BALANCE/balance.c:42-55`
- 四驱：前后轴按几何参数分配：`BALANCE/balance.c:59-71`
- 履带差速：左右履带分配与轮距折算：`BALANCE/balance.c:76-87`
- 增量式 PI：`pwm += Kp*(e(k)-e(k-1)) + Ki*e(k)`，每轮独立：`BALANCE/balance.c:518-557`
- PWM 限幅与方向极性：`BALANCE/balance.c:424-430,368-389`

## 机械臂控制
- 舵机通道映射：`TIM8->CCR1..4` 与 `TIM12->CCR1..2`：`BALANCE/balance.c:261-269`
- 角度→PWM 映射与角度/PWM 限幅：`BALANCE/balance.c:1005-1041`
- 位置式 PID 逐步到达目标位置：`BALANCE/balance.c:570-623,1047-1070`
- 自检动作序列与蜂鸣器提示：`BALANCE/balance.c:279-358,175-249`

## 外设与接口映射
- 编码器：TIM2/3/4/5 正交接口，读数后清零：`HARDWARE/encoder.c:11-54,64-99,108-142,151-186,196-208`
- 电机 PWM：TIM1/9/10/11，10kHz 设置在系统初始化：`BALANCE/system.c:279-285`，初始化细节：`HARDWARE/motor.c`
- 舵机 PWM：TIM8/TIM12 100Hz，初始化与通道配置：`HARDWARE/timer.c:326-401,404-475`
- 串口：`USART1/2/3/5` 初始化与用途，默认 `USART3` 为 ROS 通道：`BALANCE/system.c:222-241`
- CAN：接口初始化与通信：`BALANCE/system.c:248-251`，实现于 `HARDWARE/can.*`
- OLED/按键/使能等：`HARDWARE/oled.*`、`HARDWARE/key.*`、`HARDWARE/motor.c:12-21`

## 车型选择与参数初始化
- 开机读取电位器 ADC 分段选择车型：`BALANCE/robot_select_init.c:14-21`
- 初始化轮距、轴距、轮径、齿轮比、编码器精度等参数：`BALANCE/robot_select_init.c:47-83`
- 全局参数用于速度换算与逆运动学：`BALANCE/system.c:55-76`

## 运行流程（简述）
1. 系统初始化（外设、串口、ADC/CAN、编码器/电机/舵机、OLED、按键、IMU 型号识别与初始化）：`BALANCE/system.c:150-287`
2. 车型参数选择：`BALANCE/robot_select_init.c:14-37`
3. 启动 RTOS 调度与业务任务：`USER/main.c:39-46`
4. 控制任务周期执行：读取编码器→解析输入→逆运动学→PI 闭环→PWM 输出→机械臂位置控制

## 安全与异常处理
- 低电压、使能关闭或软件故障禁止运动：`BALANCE/balance.c:465-479`
- 车型错误导致电机狂转的检测与停机：`BALANCE/balance.c:990-999`
- 蜂鸣器提示与电压阈值（10.5V/10V）：`BALANCE/show.c:61-66`

## 编译与工程
- Keil 工程：`USER/WHEELTEC.uvprojx` 及相关 `uvoptx/uvguix.*`
- 启动文件与 CMSIS：`CORE/startup_stm32f40_41xxx.s`、`CORE/core_cm4*.h`
- 产物：`OBJ/WHEELTEC.hex` 与根目录 `*.hex`

## 快速入口（文件定位）
- 系统初始化总入口：`BALANCE/system.c:150`
- 控制主任务：`BALANCE/balance.c:99`
- 车型参数与选择：`BALANCE/robot_select_init.c:14,47`
- 逆运动学与速度闭环：`BALANCE/balance.c:23,518`
- 编码器读取与速度计算：`BALANCE/balance.c:913`
- 舵机控制与机械臂位置 PID：`BALANCE/balance.c:1047`