# 六自由度机械臂 PCA9685 舵机控制方案（不改代码版本）

## 概述
- 目标：将现有六自由度机械臂的舵机控制从 `TIM8/TIM12` 本地 PWM，迁移为通过 `PCA9685` I2C PWM 控制。暂不改动现有业务代码，输出接口与集成方案。
- 当前实现：机械臂 PWM 直接写定时器寄存器（`TIM8->CCR1..4`、`TIM12->CCR1..2`）见 `BALANCE/balance.c:261-269`；位置式 PID 计算目标 PWM（`BALANCE/balance.c:1047-1070`）。
- 现有 I2C 驱动：已提供软 I2C GPIO 与读写封装（`HARDWARE/I2C.c`），系统初始化已调用 `I2C_GPIOInit()`（`BALANCE/system.c:160-165`）。

## 硬件连接
- 控制芯片：`PCA9685`（16 路 12-bit PWM 输出，内置 25MHz 振荡器）。
- I2C 连接：`PB10`→`SCL`，`PB11`→`SDA`（对应现有软 I2C 实现）。
- 地址配置：默认 7-bit 地址 `0x40`（`A0~A5` 拉低）。如地址变更，软件通过可配置参数指定。
- 舵机通道：机械臂 6 舵机建议映射至 `LED0..LED5`（通道 0~5）。

## 软件架构
- 新增模块：`HARDWARE/pca9685.{h,c}`（提议），封装 I2C 读写与 PWM 设置，向上提供舵机接口。
- 新增模块：`HARDWARE/arm_servo.{h,c}`，提供六舵机目标脉宽设置与周期更新的加减速平滑控制，统一对接 TIM 或 PCA9685 输出。
- 不改动版本集成方式：
  - 在不修改 `BALANCE/balance.c` 的前期，先定义面向机械臂的统一接口原型，供后续替换：
    - `Arm_Servo_SetTargets(p1..p6)` 与 `Arm_Servo_Update()`。
    - 随后将业务层输出改用上述接口。

## PCA9685 寄存器与时序
- 关键寄存器：
  - `MODE1 (0x00)`：睡眠/重启/自动递增；`MODE2 (0x01)`：输出驱动模式。
  - `PRESCALE (0xFE)`：PWM 频率分频。
  - `LEDn_ON_L/H (0x06+4n)` 与 `LEDn_OFF_L/H (0x08+4n)`：每通道 ON/OFF 计数。
- 初始化流程（50Hz 舵机）：
  - 进入睡眠：写 `MODE1` 置 `SLEEP=1`。
  - 设置分频：`prescale = round(25e6/(4096*freq)) - 1`，50Hz 时 `prescale≈121`，写 `PRESCALE=121`。
  - 退出睡眠并开启自动递增：`MODE1` 置 `AI=1`、`SLEEP=0`，随后 `RESTART=1`。
  - 设置输出驱动：`MODE2` 置 `OUTDRV=1`（推挽输出）、`OCH=0`。

## 舵机 PWM 映射
- 周期：`20ms`（`50Hz`）；计数范围：`0..4095`。
- 脉宽到计数转换：`counts = pulse_us * freq * 4096 / 1e6`，在 50Hz 下 `counts ≈ pulse_us * 0.2048`。
  - `1000us`≈`205`；`1500us`≈`307`；`2000us`≈`410`。
- 推荐写法：`LEDn_ON=0`，`LEDn_OFF=counts`，保证固定相位且脉宽可调。
- 角度到脉宽：沿用现有 `SERVO_PWM_VALUE(angle)` 线性映射（`BALANCE/balance.c:1005-1013`）或直接采用标准 `1000~2000us` 幅度，结合每关节初始化偏置。

## 舵机加减速平滑控制
- 目标：避免舵机瞬时大幅跃迁，提升稳定性与机械寿命。
- 策略：在 100Hz 控制周期内对每关节当前脉宽向目标脉宽以最大步进限制递进（如每周期 ≤10us），形成近似梯形速度曲线。
- 接口：
  - `Arm_Servo_Init()`：初始化当前与目标脉宽并写入初始输出。
  - `Arm_Servo_SetTargets(p1..p6)`：设置六关节目标脉宽。
  - `Arm_Servo_Update()`：按步进限制推进当前值并写入输出（TIM 或 PCA9685）。
- 集成位置：在控制任务 `Balance_task` 正常模式中，`Drive_Robot_Arm()` 计算出 `Moveit_PWM1..6` 后调用 `Arm_Servo_SetTargets()` 与 `Arm_Servo_Update()`；自检模式保持原有 `Set_Mechanical_Arm()` 直接输出。

## 模块接口设计（建议）
- 设备接口：
  - `bool PCA9685_Init(uint8_t dev_addr, uint16_t freq_hz)`：初始化设备与频率。
  - `bool PCA9685_SetPWM(uint8_t channel, uint16_t on_count, uint16_t off_count)`：设置通道 ON/OFF。
  - `bool PCA9685_SetPulseUS(uint8_t channel, uint16_t pulse_us)`：按微秒设置脉宽（50Hz）。
- 机械臂接口（抽象）：
  - `bool Arm_Servo_Init()`：初始化 PCA9685 并应用默认频率与通道映射。
  - `bool Arm_Servo_Write(uint8_t index, uint16_t pulse_us)`：写入第 `index` 关节脉宽。
  - `bool Arm_Servo_WriteAngle(uint8_t index, float angle_rad)`：按角度写入脉宽（含角度限幅与偏置）。
- 映射策略：`index 0..5` → `PCA9685 channel 0..5`；其余通道保留。

## 与现有控制的衔接方案
- 位置式 PID 层保持不变（`BALANCE/balance.c:570-623,1047-1070`），产生目标 PWM 值或角度。
- 输出层替换：后续从直接写 `TIM8/TIM12` 迁移为通过 `Arm_Servo_Update()` 输出；在采用 PCA9685 后，`Arm_Servo_Update()` 内部改为写 `PCA9685_SetPulseUS()`。
- 初始化层：在系统初始化 `systemInit()` 中添加 `Arm_Servo_Init()`（在 IMU/串口/ADC/编码器后、舵机 PWM 初始化前或替换之）。
- 初始化层：在系统初始化 `systemInit()` 中添加 `Arm_Servo_Init()`（在 IMU/串口/ADC/编码器后、舵机 PWM 初始化前或替换之）。

## 参数与校准
- 频率：`50Hz`（标准舵机）。如需更小抖动可微调 `49~60Hz` 并标定。
- 角度-脉宽映射：每舵机独立校准中心点与幅度（例如中心 `1500us`，幅度 `±500us`）。
- 偏置：沿用现有初始化偏置 `Moveit_AngleX_init`（`BALANCE/balance.c:1051-1055`）或转换为脉宽偏置。
- 限幅：沿用 `moveit_angle_limit()` 与 `moveit_pwm_limit()`（`BALANCE/balance.c:1019-1041`），对应到脉宽范围。

## 异常与安全
- I2C 通信失败处理：写/读函数返回值检查，必要时重试与设备重置（重新 `RESTART`）。
- 低电压禁能：复用现有 `Turn_Off(Voltage)` 控制（`BALANCE/balance.c:465-479`），在禁能时输出 `pulse=0` 或安全脉宽（停位）。
- 看门狗与超时：在显示任务或控制任务中监控 `PCA9685_SetPWM` 返回值与错误计数。

## 实现步骤（后续）
1. 新增 `HARDWARE/arm_servo.{h,c}`，实现加减速平滑与 TIM 输出封装。
2. 在 `systemInit()` 中调用 `Arm_Servo_Init()`。
3. 在 `Balance_task` 正常控制路径中接入 `Arm_Servo_SetTargets()` 与 `Arm_Servo_Update()`。
4. 后续新增 `HARDWARE/pca9685.{h,c}`，将 `Arm_Servo_Update()` 输出由 TIM 切换为 PCA9685。
5. 进行脉宽-角度标定与限幅调整，验证自检与手动控制流程。

## 参考文件定位
- 机械臂 PWM 写寄存器：`BALANCE/balance.c:261-269`
- 机械臂位置式 PID 与角度/PWM限幅：`BALANCE/balance.c:570-623,1005-1041,1047-1070`
- I2C 驱动入口：`HARDWARE/I2C.c`；系统初始化调用：`BALANCE/system.c:160-165`